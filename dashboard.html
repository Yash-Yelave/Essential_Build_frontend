<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CureConnect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/tailwind-config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8F9FA; }
    </style>
</head>
<body class="text-gray-800 antialiased min-h-screen pb-20">
    <div class="max-w-2xl mx-auto p-5">
        <div class="flex justify-between items-center mb-8 mt-4">
            <h2 class="text-2xl font-bold text-primary">Dashboard</h2>
            <button id="logoutBtn" class="py-2 px-4 rounded-lg border border-primary text-primary hover:bg-primary/5 font-semibold text-sm transition-colors">
                Logout
            </button>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h3 id="userName" class="text-xl font-bold mb-1">Welcome!</h3>
            <p class="text-gray-500 mb-4" id="userPhone">Loading profile...</p>
            <a href="select-doctor.html" class="block w-full py-3 px-6 rounded-xl font-semibold text-center bg-primary text-white shadow-lg shadow-primary/30 hover:bg-blue-600 transition-transform active:scale-95">
                Book New Appointment
            </a>
        </div>

        <div id="liveTokenSection" class="hidden">
            <div class="bg-blue-50 border border-blue-100 rounded-2xl shadow-sm p-6 mb-6">
                <h4 class="font-bold text-lg mb-2">Live Token Status</h4>
                <div class="text-4xl font-extrabold text-primary text-center my-4 bg-white p-4 rounded-xl shadow-sm" id="dashboardToken">--</div>
                <p class="text-center font-medium mb-4" id="dashboardTokenStatus">Waiting...</p>
                <a href="token.html" class="block w-full py-2 px-4 rounded-lg border border-primary text-primary text-center hover:bg-white transition-colors">
                    View Full Screen
                </a>
            </div>
        </div>

        <h3 class="text-xl font-bold mb-4">Upcoming</h3>
        <div id="upcomingList" class="space-y-4">
            <div class="text-center text-gray-400 py-4">Loading...</div>
        </div>

        <h3 class="text-xl font-bold mb-4 mt-8">History</h3>
        <div id="historyList" class="space-y-4 opacity-80">
            <div class="text-center text-gray-400 py-4">Loading...</div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/appointment.js"></script>
    <script>
        // Auth Check
        if (!Auth.isLoggedIn()) {
            window.location.href = 'login.html';
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            Auth.logout();
        });

        async function loadDashboard() {
            // Load Profile
            const profile = await Auth.getProfile();
            if (profile) {
                document.getElementById('userName').textContent = `Welcome, ${profile.full_name || profile.username}!`;
                document.getElementById('userPhone').textContent = profile.phone_number || '';
            }

            // Load Upcoming
            const upcoming = await Appointment.getUpcoming();
            const upcomingList = document.getElementById('upcomingList');
            upcomingList.innerHTML = '';
            
            if (upcoming && upcoming.length > 0) {
                upcoming.forEach(app => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl shadow-sm p-5 border border-gray-100';
                    card.innerHTML = `
                        <h4 class="font-bold text-lg">Dr. ${app.doctor_name}</h4>
                        <p class="text-gray-600"><strong>Date:</strong> ${app.appointment_date}</p>
                        <p class="text-gray-600 mb-2"><strong>Time:</strong> ${app.appointment_time}</p>
                        <span class="inline-block px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">${app.status}</span>
                    `;
                    upcomingList.appendChild(card);
                });
                checkTokenStatus();
            } else {
                upcomingList.innerHTML = '<p class="text-gray-400 text-center">No upcoming appointments.</p>';
            }

            // Load History
            const history = await Appointment.getHistory();
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (history && history.length > 0) {
                history.forEach(app => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl shadow-sm p-5 border border-gray-100';
                    card.innerHTML = `
                        <h5 class="font-bold">Dr. ${app.doctor_name}</h5>
                        <p class="text-gray-500 text-sm mb-1">${app.appointment_date} at ${app.appointment_time}</p>
                        <small class="text-gray-400 uppercase font-semibold text-xs">${app.status}</small>
                    `;
                    historyList.appendChild(card);
                });
            } else {
                historyList.innerHTML = '<p class="text-gray-400 text-center">No past appointments.</p>';
            }
        }

        async function checkTokenStatus() {
            const status = await Appointment.getTokenStatus();
            if (status && status.token_number) {
                document.getElementById('liveTokenSection').classList.remove('hidden');
                document.getElementById('dashboardToken').textContent = status.token_number;
                document.getElementById('dashboardTokenStatus').textContent = status.status;
            }
        }

        loadDashboard();
    </script>
</body>
</html>
